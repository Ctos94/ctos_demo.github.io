import{r as e,H as l,a as t,o as a,d as i,b as s,w as n,h as o,F as d,n as u,A as r,_ as c,c as m,v as h,C as v,g as p,k as f,D as y,l as _,t as g,u as k,$ as b}from"./index-de9476e1.js";const x={__name:"RoleDialog",emits:["submited"],setup(c,{expose:m,emit:h}){const v=e(!1),p=e(!1),f=e({}),y=e(null),_=h,g=async()=>{const{valid:e}=await y.value.validate();e&&(v.value=!0,u.execute({method:f.value.id?"put":"post",url:f.value.id?r.system.role.update:r.system.role.create,data:f.value,json:!0}).then((()=>{p.value=!1,_("submited")})).finally((()=>{v.value=!1})))};return l(p,((e,l)=>{e||(y.value.reset(),f.value={})})),m({edit:e=>{f.value={...e},p.value=!0}}),(e,l)=>{const u=t("v-btn"),r=t("v-text-field"),c=t("v-card-text"),m=t("v-spacer"),h=t("v-btn-text"),_=t("v-card-actions"),k=t("v-card"),b=t("v-form"),x=t("v-dialog");return a(),i(d,null,[s(u,{color:"blue-lighten-1",text:"新增角色",onClick:l[0]||(l[0]=e=>p.value=!0)}),s(x,{modelValue:p.value,"onUpdate:modelValue":l[5]||(l[5]=e=>p.value=e),"max-width":"350"},{default:n((()=>[s(b,{onSubmit:l[4]||(l[4]=o((()=>{}),["prevent"])),ref_key:"formRef",ref:y},{default:n((()=>[s(k,null,{default:n((()=>[s(c,null,{default:n((()=>[s(r,{rules:[e.$validator.required],label:"角色名称",modelValue:f.value.name,"onUpdate:modelValue":l[1]||(l[1]=e=>f.value.name=e)},null,8,["rules","modelValue"]),s(r,{rules:[e.$validator.required,e.$validator.integer],label:"排序号",modelValue:f.value.sort,"onUpdate:modelValue":l[2]||(l[2]=e=>f.value.sort=e)},null,8,["rules","modelValue"])])),_:1}),s(_,null,{default:n((()=>[s(m),s(h,{text:"取消",onClick:l[3]||(l[3]=e=>p.value=!1)}),s(h,{disabled:v.value,loading:v.value,color:"primary",text:"保存",onClick:g},null,8,["disabled","loading"])])),_:1})])),_:1})])),_:1},512)])),_:1},8,["modelValue"])],64)}}};const V=c({data:()=>({role_id:"",visible:!1,menus:[],selected:[],loading:!1,deep_check:!1}),methods:{init(){this.loading=!0;const e=new Promise(((e,l)=>{this.$request.get({url:r.system.menu.permissions_tree}).then((l=>{e(l)}))})).then((e=>{this.menus=e})),l=new Promise(((e,l)=>{this.$request.get({url:r.system.role.authorization_ids,params:{roleId:this.role_id}}).then((l=>{e(l)}))})).then((e=>{this.selected=e}));Promise.all([e,l]).finally((()=>{this.loading=!1}))},show:function(e){this.role_id=e,this.visible=!0,this.$nextTick((()=>{this.init()}))},isSelected(e){return this.selected.some((l=>l.id===e))},toggleSelect(e){const l=(e,l)=>{let t=this.selected.map((e=>e.id)).indexOf(e.id);l?-1===t&&this.selected.push({id:e.id,type:e.classify}):-1!==t&&this.selected.splice(t,1)},t=(e,a)=>{e&&0!==e.length&&e.forEach((e=>{l(e,a),e.children&&e.children.length>0&&this.deep_check&&t(e.children,a)}))};let a=!this.isSelected(e.id);l(e,a),e.children&&e.children.length>0&&this.deep_check&&t(e.children,a)},save:function(){this.loading=!0,this.$request.post({url:r.system.role.update_authorization,data:{roleId:this.role_id,authorization:this.selected},json:!0}).then((()=>{this.$message.success("保存成功")})).finally((()=>{this.loading=!1}))}},watch:{visible(e){e||(this.selected=[],this.menus=[],this.deep_check=!1)}}},[["render",function(e,l,u,r,c,f){const y=t("v-progress-circular"),_=t("v-overlay"),g=t("v-checkbox"),k=t("v-treeview"),b=t("v-card-text"),x=t("v-switch"),V=t("v-sheet"),C=t("v-btn-text"),w=t("v-card"),S=t("v-dialog");return a(),m(S,{modelValue:c.visible,"onUpdate:modelValue":l[5]||(l[5]=e=>c.visible=e),width:"600",scrollable:""},{default:n((()=>[s(w,null,{actions:n((()=>[s(V,{width:"100%",class:"d-flex justify-space-between pl-5"},{default:n((()=>[s(V,null,{default:n((()=>[s(x,{density:"compact","hide-details":"",modelValue:c.deep_check,"onUpdate:modelValue":l[2]||(l[2]=e=>c.deep_check=e),color:"primary",label:"父子节点关联"},null,8,["modelValue"])])),_:1}),s(V,null,{default:n((()=>[s(C,{onClick:l[3]||(l[3]=e=>c.visible=!1),text:"关闭"}),s(C,{color:"primary",onClick:l[4]||(l[4]=e=>f.save()),text:"确定"})])),_:1})])),_:1})])),default:n((()=>[s(_,{modelValue:c.loading,"onUpdate:modelValue":l[0]||(l[0]=e=>c.loading=e),class:"align-center justify-center"},{default:n((()=>[s(y,{color:"primary",indeterminate:""})])),_:1},8,["modelValue"]),s(b,null,{default:n((()=>[s(k,{density:"compact",items:c.menus,"active-strategy":"classic"},{prepend:n((({item:e})=>[s(g,{density:"compact",onClick:l[1]||(l[1]=o((()=>{}),["stop"])),ripple:!1,"onUpdate:modelValue":l=>f.toggleSelect(e),"model-value":f.isSelected(e.id),"hide-details":!0},null,8,["onUpdate:modelValue","model-value"])])),title:n((({item:e})=>[h(v(e.title||e.name)+" ",1),"PAGE"===e.classify?(a(),i(d,{key:0},[h("[页面]")],64)):p("",!0),"PERMISSION"===e.classify?(a(),i(d,{key:1},[h("[权限]")],64)):p("",!0)])),_:1},8,["items"])])),_:1})])),_:1})])),_:1},8,["modelValue"])}]]),C={__name:"Roles",setup(l){const o=f(),c=y(),m=e(null),h=e(null),v=e(!1),p=[{title:"排序号",key:"sort",width:90,sortable:!1},{title:"角色",key:"name",sortable:!1},{title:"用户数",key:"userCount",width:100,align:"center",sortable:!1},{key:"actions",width:500,align:"center",sortable:!1}],C=e([]),w=()=>{v.value=!0,u.get({url:r.system.role.all}).then((e=>{C.value=e})).finally((()=>{v.value=!1}))};return _((()=>{o.commit("update_sider_active","/system/roles")})),g((()=>{w()})),(e,l)=>{const o=t("v-btn-link"),f=t("v-data-table-virtual");return a(),i(d,null,[s(x,{ref_key:"RoleDialogRef",ref:m,onSubmited:w},null,512),s(V,{ref_key:"UserMenusDialogRef",ref:h},null,512),s(f,{loading:v.value,headers:p,items:C.value},{"item.actions":n((({item:e})=>[s(o,{text:"编辑",onClick:l=>m.value.edit(e)},null,8,["onClick"]),s(o,{onClick:()=>{k(c).push({path:"/system/role/users",query:{id:e.id}})},text:"关联用户"},null,8,["onClick"]),s(o,{onClick:l=>h.value.show(e.id),text:"关联菜单 & 权限"},null,8,["onClick"]),s(o,{onClick:l=>{return t=e.id,void b({message:"是否要删除？",beforeClose:(e,l,a)=>{"confirm"===e?u.delete({url:r.system.role.delete,data:{id:t}}).then((()=>{a()})):a()}}).then((()=>{w()})).catch((()=>{}));var t},text:"删除"},null,8,["onClick"])])),_:1},8,["loading","items"])],64)}}};export{C as default};
