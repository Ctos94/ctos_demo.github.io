import{_ as e}from"./DateInput-f02aa55d.js";import{_ as t,I as a,A as i,a as l,o as s,c as o,w as n,d,F as r,v as c,C as u,f as h,b as g,g as m,J as p,K as k,i as y,m as b,e as f}from"./index-de9476e1.js";import{P as v}from"./PriceFormat-3bb708db.js";import"./common-5afeacdf.js";const w={class:"d-inline-flex align-start header"},C={key:0},q={key:1,class:"text-grey text-caption align-self-center"},T={class:"d-flex justify-end"};const x=t({components:{AutoTagTask:t({components:{Loading:a},data:()=>({task:void 0,interval:null}),computed:{disabled(){return void 0===this.task||this.task&&("RUNNING"===this.task.state||"DISABLED"===this.task.state)}},mounted(){this.state()},methods:{startLoop(){this.interval&&clearInterval(this.interval),this.interval=setInterval((()=>{this.$request.get({url:i.bill.autoTagTask.state}).then((e=>{this.task=e,e&&"RUNNING"!==e.state&&(this.interval&&clearInterval(this.interval),this.$confirm({message:"智能标注任务已完成，是否刷新当前页面?"}).then((()=>{location.reload()})).catch((()=>{this.task=void 0})))}))}),1e4)},state(){this.interval&&clearInterval(this.interval),this.$request.get({url:i.bill.autoTagTask.state}).then((e=>{this.task=e,e&&"RUNNING"===e.state&&this.startLoop()}))},start(){this.$confirm({message:"是否开启智能标注?",beforeClose:(e,t,a)=>{"confirm"===e?(t.confirmButtonLoading=!0,this.$request.post({url:i.bill.autoTagTask.start}).then((()=>{this.state(),a()}))):a()}}).then((()=>{})).catch((()=>{}))},shutdown(e){this.$confirm({message:"是否终止智能标注任务?",beforeClose:(t,a,l)=>{"confirm"===t?(a.confirmButtonLoading=!0,this.$request.post({url:i.bill.autoTagTask.shutdown,data:{id:e}}).then((()=>{a.confirmButtonLoading=!1,this.task=void 0,l()}))):l()}}).then((()=>{this.state()})).catch((()=>{}))},confirm(e){this.$request.post({url:i.bill.autoTagTask.sync,data:{id:e},loading:{target:"#list"}}).then((()=>{location.reload()}))}}},[["render",function(e,t,a,i,y,b){const f=l("Loading"),v=p,w=l("v-icon"),C=l("v-btn"),q=k;return s(),o(q,{effect:"dark",placement:"bottom"},{content:n((()=>[y.task?(s(),d(r,{key:0},["RUNNING"===y.task.state?(s(),d(r,{key:0},[c(u(y.task.id?`正在执行智能标注任务，开始时间：${y.task.createdDate}`:"智能标注任务未能正确关闭")+" ",1),h("span",{class:"text-red pointer auto-tag-btn",onClick:t[0]||(t[0]=e=>b.shutdown(y.task.id))},"终止 ")],64)):"FAIL"===y.task.state?(s(),d(r,{key:1},[c(" 智能标注任务失败 ")],64)):"CONFIRM"===y.task.state?(s(),d(r,{key:2},[c(" 智能标注任务完成 "),h("span",{class:"text-red pointer auto-tag-btn",onClick:t[1]||(t[1]=e=>b.confirm(y.task.id))},"确认标注")],64)):"DISABLED"===y.task.state?(s(),d(r,{key:3},[c(" 暂无待标注数据 ")],64)):(s(),d(r,{key:4},[c("根据交易方和支出项自动标注标签")],64))],64)):(s(),d(r,{key:1},[c("根据交易方和支出项自动标注标签")],64))])),default:n((()=>[g(C,{class:"ml-2",color:"blue-lighten-1",disabled:b.disabled,onClick:b.start},{default:n((()=>[c("智能标注 "),y.task?(s(),d(r,{key:0},["RUNNING"===y.task.state?(s(),o(v,{key:0,style:{"margin-left":"5px"},class:"is-loading"},{default:n((()=>[g(f)])),_:1})):"FAIL"===y.task.state?(s(),o(w,{key:1,class:"ml-2",icon:"mdi-alert-circle"})):m("",!0)],64)):m("",!0)])),_:1},8,["disabled","onClick"])])),_:1})}],["__scopeId","data-v-d33fce2a"]]),PriceFormat:v,DateInput:e},data:()=>({tableMaxHeight:0,query:{date:"",tags:[],isOnlyShowAutoTag:!1,keyword:""},pagination:{currentPage:1,pageSize:50,total:0},bills:[],tags:[],editrows:{},loading:!1}),beforeMount(){this.handleTableMaxHeight()},mounted(){const e=this.$route;e.query&&(e.query.tag&&this.query.tags.push(e.query.tag),e.query.date&&(this.query.date=e.query.date),this.$router.replace({query:{}})),this.$store.commit("update_sider_active","/bill/list"),window.onresize=()=>{this.handleTableMaxHeight()},this.$request.get({url:i.bill.list.tags,loading:{target:"#list"}}).then((e=>{this.tags=e,this.requestData()}))},methods:{handleTableMaxHeight(){this.tableMaxHeight=document.documentElement.clientHeight-190},requestData(){this.loading=!0,this.$request.get({url:i.bill.list.page,params:{page:this.pagination.currentPage,pageSize:this.pagination.pageSize,date:this.query.date,isOnlyShowAutoTag:this.query.isOnlyShowAutoTag,tags:this.query.tags.join(","),keyword:this.query.keyword}}).then((e=>{this.pagination.total=e.total,this.bills=e.contents})).finally((()=>{this.loading=!1}))},deleteRow(e){this.$confirm({message:"确定要删除吗？"}).then((()=>{this.loading=!0,this.$request.delete({url:i.bill.list.delete,data:{id:e.id}}).then((()=>{this.requestData()}))})).catch((()=>{}))},updateTag(e,t){let a={id:e.id,tag:t,type:e.autoTag?"autoTag":"tag"};this.loading=!0,this.$request.put({url:i.bill.list.updateTag,data:a}).then((()=>{e.autoTag?e.autoTag=t:e.tag=t})).finally((()=>{this.loading=!1}))},async handleCellClick(e,t,a){switch(e){case"edit":t.edit=!0,this.editrows[t.id]=JSON.parse(JSON.stringify(t)),this.bills.splice(a,1,t),this.$nextTick((()=>{this.$refs[`cell-edit-${t.id}`].focus()}));break;case"save":const{valid:e}=await this.$refs.form.validate();if(!e)return;this.loading=!0,this.$request.put({url:i.bill.list.updateDetail,data:{id:t.id,detail:this.editrows[t.id].detail,price:this.editrows[t.id].price}}).then((()=>{t.edit=!1,t.detail=this.editrows[t.id].detail,t.price=this.editrows[t.id].price,this.bills.splice(a,1,t),delete this.editrows[t.id]})).finally((()=>{this.loading=!1}));break;case"cancel":t.edit=!1,this.bills.splice(a,1,t),delete this.editrows[t.id]}}}},[["render",function(t,a,i,p,k,v){const x=e,$=l("v-select"),_=l("v-text-field"),V=l("v-checkbox"),I=l("v-btn"),N=l("AutoTagTask"),U=l("v-sheet"),S=l("PriceFormat"),D=l("v-icon"),A=l("v-chip"),L=l("v-list-item-title"),P=l("v-list-item"),M=l("v-divider"),O=l("v-list"),R=l("v-menu"),F=l("v-btn-link"),H=l("v-pagination"),j=l("v-data-table"),z=l("v-form");return s(),o(U,{id:"list"},{default:n((()=>[h("div",w,[g(x,{label:"选择月份",clearable:"",width:150,density:"compact",modelValue:k.query.date,"onUpdate:modelValue":a[0]||(a[0]=e=>k.query.date=e)},null,8,["modelValue"]),g($,{class:"ml-2",width:"250px",variant:"outlined",density:"compact","hide-details":"",modelValue:k.query.tags,"onUpdate:modelValue":a[1]||(a[1]=e=>k.query.tags=e),clearable:"",multiple:"",label:"标签",items:["EMPTY"].concat(this.tags)},{selection:n((({item:e,index:t})=>[t<1?(s(),d("span",C,u(e.title),1)):m("",!0),1===t?(s(),d("span",q," (+"+u(k.query.tags.length-1)+" others) ",1)):m("",!0)])),_:1},8,["modelValue","items"]),g(_,{class:"ml-2",width:"200px",variant:"outlined",density:"compact","hide-details":"",clearable:"",modelValue:k.query.keyword,"onUpdate:modelValue":a[2]||(a[2]=e=>k.query.keyword=e),label:"交易方|支出项"},null,8,["modelValue"]),g(V,{class:"ml-2",density:"compact",modelValue:k.query.isOnlyShowAutoTag,"onUpdate:modelValue":a[3]||(a[3]=e=>k.query.isOnlyShowAutoTag=e),label:"仅显示智能标注数据"},null,8,["modelValue"]),g(I,{class:"ml-2",color:"blue-lighten-1",onClick:a[4]||(a[4]=()=>{k.pagination.currentPage=1,v.requestData()}),text:"检索"}),g(N)]),g(z,{ref:"form"},{default:n((()=>[g(j,{"show-current-page":"",page:k.pagination.currentPage,"items-per-page":k.pagination.pageSize,headers:[{title:"日期",key:"date",width:180,sortable:!1},{title:"交易方",key:"payee",width:300,sortable:!1},{title:"支出项",key:"detail",sortable:!1},{title:"金额",key:"price",width:180,sortable:!1},{title:"标签",key:"tag",align:"center",width:120,sortable:!1},{title:"操作",key:"actions",width:80,align:"center",sortable:!1}],height:k.tableMaxHeight,items:k.bills,loading:k.loading,"item-key":"id"},{"item.detail":n((({item:e,index:a})=>[e.edit?(s(),o(U,{key:1,class:"d-flex align-center"},{default:n((()=>[g(_,{onKeyup:[y((t=>v.handleCellClick("save",e,a)),["enter"]),y((t=>v.handleCellClick("cancel",e,a)),["esc"])],class:"mr-2",variant:"outlined",density:"compact","hide-details":"",ref:`cell-edit-${e.id}`,rules:[t.$validator.required],modelValue:k.editrows[e.id].detail,"onUpdate:modelValue":t=>k.editrows[e.id].detail=t},null,8,["onKeyup","rules","modelValue","onUpdate:modelValue"]),g(I,{class:"mr-2",color:"blue-lighten-1",onClick:t=>v.handleCellClick("save",e,a),text:"保存"},null,8,["onClick"]),g(I,{color:"red",onClick:t=>v.handleCellClick("cancel",e,a),text:"取消"},null,8,["onClick"])])),_:2},1024)):(s(),o(U,{key:0,class:"pointer",onClick:t=>v.handleCellClick("edit",e,a)},{default:n((()=>[c(u(e.detail),1)])),_:2},1032,["onClick"]))])),"item.price":n((({item:e,index:a})=>[e.edit?(s(),o(U,{key:1,class:"d-flex align-center"},{default:n((()=>[g(_,{onKeyup:[y((t=>v.handleCellClick("save",e,a)),["enter"]),y((t=>v.handleCellClick("cancel",e,a)),["esc"])],ref:`${e.id}_price`,class:"mr-2",variant:"outlined",density:"compact","hide-details":"",rules:[t.$validator.required,t.$validator({rule:"price",params:{max:99999999.99}})],modelValue:k.editrows[e.id].price,"onUpdate:modelValue":t=>k.editrows[e.id].price=t},null,8,["onKeyup","rules","modelValue","onUpdate:modelValue"])])),_:2},1024)):(s(),o(U,{key:0,class:"pointer",onClick:t=>v.handleCellClick("edit",e,a)},{default:n((()=>[g(S,{amount:e.price},null,8,["amount"])])),_:2},1032,["onClick"]))])),"item.tag":n((({item:e})=>[g(R,{density:"compact"},{activator:n((({props:t})=>[g(A,b(t,{color:e.autoTag?"orange-lighten-1":"blue-lighten-1",rounded:"sm"}),{default:n((()=>[e.tag||e.autoTag?(s(),d(r,{key:1},[c(u(e.autoTag?e.autoTag:e.tag),1)],64)):(s(),o(D,{key:0,icon:"mdi-plus"}))])),_:2},1040,["color"])])),default:n((()=>[g(O,{class:"pa-0",density:"compact"},{default:n((()=>[(s(!0),d(r,null,f(k.tags,(t=>(s(),o(P,{onClick:a=>v.updateTag(e,t),key:t,value:t},{default:n((()=>[g(L,null,{default:n((()=>[c(u(t),1)])),_:2},1024)])),_:2},1032,["onClick","value"])))),128)),g(M),e.tag||e.autoTag?(s(),o(P,{key:0,class:"text-center",onClick:t=>v.updateTag(e),title:"清  除",value:""},null,8,["onClick"])):m("",!0)])),_:2},1024)])),_:2},1024)])),"item.actions":n((({item:e})=>[g(F,{text:"删除",onClick:t=>v.deleteRow(e)},null,8,["onClick"])])),bottom:n((()=>[h("div",T,[g(H,{density:"comfortable",modelValue:k.pagination.currentPage,"onUpdate:modelValue":[a[5]||(a[5]=e=>k.pagination.currentPage=e),v.requestData],length:Math.floor(k.pagination.total/k.pagination.pageSize)+1,"total-visible":7},null,8,["modelValue","length","onUpdate:modelValue"])])])),_:1},8,["page","items-per-page","height","items","loading"])])),_:1},512)])),_:1})}],["__scopeId","data-v-6b9480d7"]]);export{x as default};
